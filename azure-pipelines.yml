trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  DB_USER: "mottuuser"
  DB_PASSWORD: "MottuPass123!"
  DB_NAME: "mottuflow"
  RESOURCE_GROUP: "sprint-mottuflow"
  WEBAPP_NAME: "mottuflow-app"
  APP_PLAN: "mottuflow-plan"
  LOCATION: "brazilsouth"
  ACI_NAME: "mottuflow-db"
  CONTAINER_IMAGE: "mysql:8.0"

stages:

- stage: Build
  displayName: "Build Stage"
  jobs:
    - job: Build
      container: maven:3.9.11-eclipse-temurin-21-noble
      steps:
        - checkout: self
        - task: Maven@4
          inputs:
            mavenPomFile: "MottuFlow/pom.xml"
            goals: "clean package -DskipTests=true"
        - task: CopyFiles@2
          inputs:
            SourceFolder: "$(System.DefaultWorkingDirectory)/MottuFlow/target"
            Contents: "*.jar"
            TargetFolder: "$(Build.ArtifactStagingDirectory)"
        - publish: $(Build.ArtifactStagingDirectory)
          artifact: demo

- stage: MySQL
  displayName: "Provision MySQL ACI"
  dependsOn: Build
  jobs:
    - job: CreateACI
      steps:
        - task: AzureCLI@2
          inputs:
            azureSubscription: "mottuflow-connection"
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az group create --name $RESOURCE_GROUP --location $LOCATION

              az container show --resource-group $RESOURCE_GROUP --name $ACI_NAME >/dev/null 2>&1 || \
              az container create \
                --resource-group $RESOURCE_GROUP \
                --name $ACI_NAME \
                --image $CONTAINER_IMAGE \
                --ports 3306 \
                --os-type Linux \
                --cpu 1 \
                --memory 1.5 \
                --dns-name-label "${ACI_NAME}-dns-${BUILD_BUILDID}" \
                --ip-address public \
                --environment-variables MYSQL_ROOT_PASSWORD="$DB_PASSWORD" MYSQL_DATABASE="$DB_NAME" MYSQL_USER="$DB_USER" MYSQL_PASSWORD="$DB_PASSWORD" \
                --restart-policy Always

              DB_IP=""
              while [ -z "$DB_IP" ]; do
                DB_IP=$(az container show --resource-group $RESOURCE_GROUP --name $ACI_NAME --query ipAddress.ip -o tsv)
                [ -z "$DB_IP" ] && sleep 5
              done
              echo "##vso[task.setvariable variable=DB_IP]$DB_IP"

- stage: Deploy
  displayName: "Deploy Web App"
  dependsOn: MySQL
  jobs:
    - deployment: DeployWebApp
      environment: Production
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              - task: AzureCLI@2
                inputs:
                  azureSubscription: "mottuflow-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az appservice plan show --name $APP_PLAN --resource-group $RESOURCE_GROUP >/dev/null 2>&1 || \
                    az appservice plan create --name $APP_PLAN --resource-group $RESOURCE_GROUP --sku B1 --is-linux --location $LOCATION

                    az webapp show --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP >/dev/null 2>&1 || \
                    az webapp create --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP --plan $APP_PLAN --runtime "JAVA|21-java21"

              - task: DownloadBuildArtifacts@1
                inputs:
                  buildType: 'current'
                  downloadType: 'single'
                  artifactName: 'demo'
                  downloadPath: '$(Pipeline.Workspace)/demo'

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: "mottuflow-connection"
                  appType: "webAppLinux"
                  appName: "$(WEBAPP_NAME)"
                  package: "$(Pipeline.Workspace)/demo/*.jar"

              - task: AzureCLI@2
                inputs:
                  azureSubscription: "mottuflow-connection"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az webapp config appsettings set \
                      --name $WEBAPP_NAME \
                      --resource-group $RESOURCE_GROUP \
                      --settings DB_HOST=$(DB_IP) DB_PORT=3306 DB_NAME=$DB_NAME DB_USER=$DB_USER DB_PASSWORD=$DB_PASSWORD
